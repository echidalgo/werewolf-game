<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Werewolf</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        class Card extends Phaser.GameObjects.Sprite {

            constructor(scene, x, y, character) {
                super(scene, x, y);

                this.character = character;
                this.setTexture(this.character);
                this.hidden = false;
                this.chosen = false;
                this.setAlpha(0.4);
                this.setPosition(x, y);
            }

            flip() {
                if (this.hidden) {
                    this.setTexture(this.character);
                    this.hidden = false;
                }
                else {
                    this.setTexture('card');
                    this.hidden = true;
                }
            }

            swap(otherCard) {
                var oldX = this.x;
                var oldY = this.y;
                this.setPosition(otherCard.x, otherCard.y)
                otherCard.setPosition(oldX, oldY);
            }

            resetAlph() {
                this.setAlpha(1);
            }

            choose() {
                if (this.chosen) {
                    this.chosen = false;
                    this.setAlpha(0.4);
                } else {
                    this.chosen = true;
                    this.clearTint();
                    this.setAlpha(1);
                }
            }

            select() {
                this.chosen = true;
                this.setAlpha(0.4);
            }

            deselect() {
                this.chosen = false;
                this.setAlpha(1);
            }
        }

        var config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 800,
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var game = new Phaser.Game(config);
        // Visuals
        var originX;
        var originY;
        var table;
        var background;
        var selectedText;

        // Characters
        var werewolf1;
        var werewolf2;
        var minion;
        var seer;
        var troublemaker;
        var robber;
        var mason1;
        var mason2;
        var insomniac;
        var tanner;
        var drunk;
        var hunter;
        var doppleganger;
        var villager1;
        var villager2;
        var villager3;

        // Players
        var name;
        var playerMap;
        var textEntry;

        // Gameplay
        var selectedCard;
        var selected;
        var playerCount;
        var allCards;
        var chosenCards;
        var gameStarted = false;
        var cardCount = 0;
        var cardCountText;
        var hideAll;
        var showAll;
        var instructions;

        function preload() {
            this.load.image('card', 'assets/card.png');
            this.load.image('table', 'assets/table2.png');
            this.load.image('werewolf', 'assets/werewolf.jpg');
            this.load.image('minion', 'assets/minion.jpg');
            this.load.image('seer', 'assets/seer.jpg');
            this.load.image('troublemaker', 'assets/troublemaker.jpg');
            this.load.image('robber', 'assets/robber.jpg');
            this.load.image('mason', 'assets/mason.jpg');
            this.load.image('insomniac', 'assets/insomniac.jpg');
            this.load.image('tanner', 'assets/tanner.jpg');
            this.load.image('drunk', 'assets/drunk.jpg');
            this.load.image('hunter', 'assets/hunter.jpg');
            this.load.image('villager', 'assets/villager.jpg');
            this.load.image('doppleganger', 'assets/doppleganger.jpg');
            this.load.image('background', 'assets/nightsky.jpg');
        }

        function create() {
            playerMap = {};

            originX = 600;
            originY = 400;
            background = this.add.image(originX, originY, 'background').setScale(0.5).setInteractive();
            table = this.add.image(originX, originY, 'table').setScale(0.7).setInteractive();
            table.setVisible(false);
            this.input.mouse.disableContextMenu();

            werewolf1 = this.add.existing(new Card(this, originX - 250, originY - 250, 'werewolf')).setInteractive();
            werewolf2 = this.add.existing(new Card(this, originX - 150, originY - 250, 'werewolf')).setInteractive();
            minion = this.add.existing(new Card(this, originX - 50, originY - 250, 'minion')).setInteractive();
            villager1 = this.add.existing(new Card(this, originX + 50, originY - 250, 'villager')).setInteractive();
            villager2 = this.add.existing(new Card(this, originX + 150, originY - 250, 'villager')).setInteractive();
            villager3 = this.add.existing(new Card(this, originX + 250, originY - 250, 'villager')).setInteractive();

            seer = this.add.existing(new Card(this, originX - 250, originY - 100, 'seer')).setInteractive();
            troublemaker = this.add.existing(new Card(this, originX - 150, originY - 100, 'troublemaker')).setInteractive();
            robber = this.add.existing(new Card(this, originX - 50, originY - 100, 'robber')).setInteractive();
            insomniac = this.add.existing(new Card(this, originX + 50, originY - 100, 'insomniac')).setInteractive();
            mason1 = this.add.existing(new Card(this, originX + 150, originY - 100, 'mason')).setInteractive();
            mason2 = this.add.existing(new Card(this, originX + 250, originY - 100, 'mason')).setInteractive();

            drunk = this.add.existing(new Card(this, originX - 250, originY + 50, 'drunk')).setInteractive();
            tanner = this.add.existing(new Card(this, originX - 150, originY + 50, 'tanner')).setInteractive();
            hunter = this.add.existing(new Card(this, originX - 50, originY + 50, 'hunter')).setInteractive();
            doppleganger = this.add.existing(new Card(this, originX + 50, originY + 50, 'doppleganger')).setInteractive();

            selectedCard = null;

            name2 = this.add.text(1000, 10, '', { fill: '#00ff00' });
            // textEntry = this.add.text(10, 300, 'CLICK TO ADD NAME',
            //     { fill: '#472F0D', backgroundColor: '#FFD966' }).setInteractive();
            cardCountText = this.add.text(50, 500, '', { fill: '#00ff00' });
            start = this.add.text(550, 600, 'Start Game',
                { fill: '#472F0D', backgroundColor: '#FFD966' }).setInteractive();
            hideAll = this.add.text(100, 450, 'Hide All',
                { fill: '#472F0D', backgroundColor: '#FFD966' });
            showAll = this.add.text(100, 500, 'Show All',
                { fill: '#472F0D', backgroundColor: '#FFD966' });
            hideAll.setVisible(false);
            showAll.setVisible(false);
            instructions = this.add.text(30, 10, '', { fill: '#00ff00' });
            instructions.setVisible(false);

            allCards = new Array(werewolf1, werewolf2, minion,
                seer, troublemaker, robber, mason1, mason2, insomniac,
                tanner, drunk, hunter, doppleganger, villager1, villager2,
                villager3);

            allCards.forEach(function (card) {
                card.setScale(0.7);
            });

            start.once("pointerup", function (pointer) {
                gameStarted = true;
                start.setVisible(false);
                cardCountText.setVisible(false);
                start.removeInteractive();
                table.setVisible(true);

                chosenCards = new Array();
                allCards.forEach(function (card) {
                    if (card.chosen) {
                        chosenCards.push(card);
                        card.flip();
                    } else {
                        card.setVisible(false);
                        card.setActive(false);
                        card.removeInteractive();
                    }
                });

                playerCount = chosenCards.length - 3;
                var cardPositions = makePositions(playerCount, 250);
                shuffle(cardPositions);

                for (let i = 0; i < chosenCards.length; i++) {
                    chosenCards[i].setPosition(cardPositions[i][0], cardPositions[i][1]);
                }

                instructions.setVisible(true);
                instructions.setText([
                    'click a card to select it, then click a different',
                    'card to swap their positions. to deselect,',
                    'click on the selected card again or on',
                    'the table. right click to flip the',
                    'card over.'
                ]);
                hideAll.setVisible(true);
                showAll.setVisible(true);
                hideAll.setInteractive();
                showAll.setInteractive();
            });

            // keys = this.input.keyboard.addKeys('A,B,C');

            // keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            // keyBackspace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.BACKSPACE);

            // this.input.keyboard.on('keydown', function (event) {
            //     if (selectedText != null) {
            //         if (event.keyCode === 8 && selectedText.text.length > 0) {
            //             selectedText.text = selectedText.text.substr(0, selectedText.text.length - 1);
            //         }
            //         else if (event.keyCode === 32 || (event.keyCode >= 48 && event.keyCode < 90)) {
            //             selectedText.text += event.key;
            //         }
            //     }

            // });

            this.input.on("gameobjectup", function (pointer, gameObject) {
                if (gameObject instanceof Card) {
                    if (gameStarted) {
                        if (pointer.rightButtonDown()) {
                            gameObject.flip();
                            if (selectedCard != null) {
                                selectedCard.deselect();
                                selectedCard = null;
                            }
                        } else {
                            if (selectedCard === gameObject) {
                                // deselect card
                                selectedCard.deselect();
                                selectedCard = null;
                            } else if (selectedCard == null) {
                                // select card
                                selectedCard = gameObject;
                                gameObject.select();
                            } else {
                                // swap with selected card
                                gameObject.swap(selectedCard);
                                selectedCard.deselect();
                                selectedCard = null;
                            }
                        }
                    } else {
                        gameObject.choose();
                        if (gameObject.chosen) {
                            cardCount++;
                        } else {
                            cardCount--;
                        }
                    }
                } else if (gameObject === hideAll) {
                    chosenCards.forEach(function (card) {
                        if (!card.hidden) {
                            card.flip();
                        }
                    });
                } else if (gameObject === showAll) {
                    chosenCards.forEach(function (card) {
                        if (card.hidden) {
                            card.flip();
                        }
                    });
                // } else if (gameObject instanceof Phaser.GameObjects.Text && gameObject != start) {
                //     // rewrite text
                //     selectedText = gameObject;
                //     gameObject.setAlpha(0.4);
                } else {
                    // deselect card
                    if (selectedCard != null) {
                        selectedCard.deselect();
                        selectedCard = null;
                    }
                }
            });
        }

        function update() {
            var pointer = this.input.activePointer;

            name2.setText([
                'x: ' + pointer.worldX,
                'y: ' + pointer.worldY,
                'isDown: ' + pointer.isDown
            ]);

            cardCountText.setText("Cards selected: " + cardCount);
        }

        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function makePositions(playerCount, distance) {
            var theta = (2 * Math.PI) / playerCount;
            var currentAngle = (Math.PI / 2);
            var p = new Array();
            for (let i = 0; i < playerCount; i++) {
                currentAngle += theta;
                var x = originX + (distance * Math.cos(currentAngle));
                var y = originY + (distance * Math.sin(currentAngle));
                p.push([x, y]);
            }
            // add centercards
            p.push([originX - 100, originY]);
            p.push([originX, originY]);
            p.push([originX + 100, originY]);
            return p;
        }

    </script>

</body>

</html>